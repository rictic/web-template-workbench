<!DOCTYPE html>
<!--
Benchmark generated via the following invocation:
node generator/build/index.js -r lit-html,lit-html@tot=generator/scripts/package-versions-tot.json,lit-html@release=generator/scripts/package-versions-release.json -n template-heavy -o lit-html/template-heavy -u 10 -q -m render,update -g

Parameters:
  renderers: lit-html
  depth: 5
  width: 4
  attrPerNode: 4
  dynAttrPct: 0.5
  valPerDynAttr: 2
  dynNodePct: 0.5
  updateCount: 10
  updateNodePct: 1
  updateAttrPct: 1
  uniqueTemplates: true
  measure: render,update
-->
<html>
  <head> </head>
  <body>
    <div id="gcavailable"></div>
    <button id="runMany">Run N times</button>
    <span id="spinner" style="display: none">Running...</span>
    <div>
      <div>
        <label>Runs: <input type="number" id="numTimes" /> </label>
      </div>
    </div>
    <div id="results"></div>
    <script type="module">
      import { update } from "./heavy.js";

      let numRuns = 1000;
      let running = false;
      if (!window.gc) {
        gcavailable.textContent = `
          window.gc is not available, run with --js-flags="--expose-gc" to get
          more accurate results.
        `;
      }
      const runManyButton = document.querySelector("#runMany");
      runManyButton.addEventListener("click", () => {
        runMany(numRuns);
      });
      const numTimesInput = document.querySelector("#numTimes");
      numTimesInput.value = numRuns;
      function updateNumTimes() {
        numRuns = Number(numTimesInput.value);
        runManyButton.textContent = `Run ${numRuns} times`;
        main();
      }
      numTimesInput.addEventListener("input", updateNumTimes);
      const domParts = {
        name: "DOM Parts",
        options: { useDomParts: true },
        times: [],
        cloneTimes: [],
        getPartsTimes: [],
        adoptTimes: [],
        createManualPartTimes: [],
      };
      const manual = {
        name: "Manual",
        options: { useDomParts: false },
        times: [],
        cloneTimes: [],
        getPartsTimes: [],
        adoptTimes: [],
        createManualPartTimes: [],
      };
      updateNumTimes();
      // ensure that <template>s are created for both versions first,
      // because our DOM Parts template creation code is not optimized yet.
      update(document.createElement("div"), domParts.options);
      update(document.createElement("div"), manual.options);
      function reportTimes(times) {
        const average = times.reduce((a, b) => a + b, 0) / times.length;
        const stdDev = Math.sqrt(
          times.reduce((a, b) => a + (b - average) ** 2, 0) / times.length
        );
        return `${average.toFixed(3)}ms Â±${stdDev.toFixed(3)}ms`;
      }
      function drawConfig(config) {
        let timesReport = document.createElement("ul");
        const configMap = {
          "Clone template": "cloneTimes",
          "Get parts": "getPartsTimes",
          Adopt: "adoptTimes",
          "Create part wrappers": "createManualPartTimes",
          Overall: "times",
        };
        if (config.times.length > 0) {
          for (const [name, field] of Object.entries(configMap)) {
            const li = document.createElement("li");
            li.textContent = `${name}: ${reportTimes(config[field])}`;
            timesReport.appendChild(li);
          }
        }
        function testAndUpdate() {
          test(config);
          main();
        }
        const div = document.createElement("div");
        const button = document.createElement("button");
        button.textContent = config.name;
        button.addEventListener("click", testAndUpdate);
        div.appendChild(button);
        div.appendChild(timesReport);
        return div;
      }
      function drawComparison(left, right) {
        if (left.times.length === 0 || right.times.length === 0) {
          return document.createElement("div");
        }
        const leftAverage =
          left.times.reduce((a, b) => a + b, 0) / left.times.length;
        const rightAverage =
          right.times.reduce((a, b) => a + b, 0) / right.times.length;
        const diff = leftAverage - rightAverage;
        let faster, slower;
        if (diff < 0) {
          faster = left;
          slower = right;
        } else {
          faster = right;
          slower = left;
        }
        const timesFaster =
          1 + Math.abs(diff) / Math.min(leftAverage, rightAverage);
        const div = document.createElement("div");
        div.textContent = `
          ${faster.name} is ${timesFaster.toFixed(2)}x faster than
          ${slower.name} over ${left.times.length} runs.
        `;
        return div;
      }
      function main() {
        if (running) {
          spinner.style.display = "inline";
          runManyButton.disabled = true;
        } else {
          spinner.style.display = "none";
          runManyButton.disabled = false;
        }
        results.replaceChildren(
          drawConfig(domParts),
          drawConfig(manual),
          drawComparison(domParts, manual)
        );
      }
      async function waitForPaint() {
        await new Promise((resolve) => requestAnimationFrame(resolve));
        await new Promise((resolve) => requestAnimationFrame(resolve));
      }
      async function runMany(count) {
        running = true;
        main();
        await waitForPaint();
        for (let i = 0; i < count; i++) {
          // periodically update the UI and yield to the event loop so we don't
          // seem unresponsive
          if (i % 20 === 0) {
            main();
            await waitForPaint();
          }

          test(manual);
          test(domParts);
        }
        running = false;
        main();
      }
      main();
      function test(config) {
        if (window.gc) {
          window.gc();
          window.gc();
        }
        const container = document.createElement("div");
        document.body.appendChild(container);
        const startTime = performance.now();
        update(container, config.options);
        config.times.push(performance.now() - startTime);
        config.cloneTimes.push(
          performance.getEntriesByName("clone template").pop().duration
        );
        config.getPartsTimes.push(
          performance.getEntriesByName("get parts").pop().duration
        );
        config.adoptTimes.push(
          performance.getEntriesByName("adopt").pop().duration
        );
        config.createManualPartTimes.push(
          performance.getEntriesByName("create part wrappers").pop().duration
        );
        document.body.removeChild(container);
      }
      runMany(numRuns);
    </script>
  </body>
</html>
